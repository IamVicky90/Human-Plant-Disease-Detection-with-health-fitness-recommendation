version: 2
jobs:
  build:
    environment:
      DOCKER_IMAGE_NAME: human-and-plant-disease-detection-with-health-and-fitness-recommendation
      # TAG: 0.1.$CIRCLE_BUILD_NUM
    docker:
      - image: circleci/python:3.6.2-stretch-browsers
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD 
    steps:
      - checkout
      - restore_cache:
          key: deps1-{{ .Branch }}-{{ checksum "requirements.txt" }}
      - run:
          name: Install Python deps in a venv
          command: |
            echo 'export TAG=0.1.${CIRCLE_BUILD_NUM}' >> $BASH_ENV
            echo 'export IMAGE_NAME=${DOCKER_IMAGE_NAME}' >> $BASH_ENV
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - save_cache:
          key: deps1-{{ .Branch }}-{{ checksum "requirements.txt" }}
          paths:
            - "venv"
  # publish-latest:
  #   # environment:
  #   #   IMAGE_NAME: human-and-plant-disease-detection-with-health-and-fitness-recommendation
  #     # TAG: 0.1.$CIRCLE_BUILD_NUM
  #   docker:
  #     - image: circleci/python:3.6.2-stretch-browsers
  #   steps:
      # - run:
      #     name: Build and push Docker image
      #     command: |
      #       docker login -u $DOCKERHUB_USER -p $DOCKER_HUB_PASSWORD_USER docker.io
      #       docker push $DOCKERHUB_USER/$IMAGE_NAME:$TAG
      - setup_remote_docker
      - run:
          name: Build and push Docker image
          command: |
            docker build -t $DOCKERHUB_USER/$IMAGE_NAME:$TAG .
            echo "$DOCKERHUB_PASSWORD" | docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD docker.io
            
            docker push $DOCKERHUB_USER/$IMAGE_NAME:$TAG
workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: main
      # - publish-latest:
      #     requires:
      #       - build
          # filters:
          #   branches:
          #     only: main
              
# version: 2.1

# jobs:
#   build-and-test:
#     # executor: health/default
#     docker:
#       - image: ubuntu-2004:202010-01
#         auth:
#           username: iamvicky90
#           password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    # steps:
    #   - checkout
    #   - restore_cache:
    #       key: deps1-{{ .Branch }}-{{ checksum "requirements.txt" }}
    #   - run:
    #       name: Install Python deps in a venv
    #       command: |
    #         echo 'export TAG=0.1.${CIRCLE_BUILD_NUM}' >> $BASH_ENV
    #         echo 'export IMAGE_NAME=${DOCKER_IMAGE_NAME}' >> $BASH_ENV
    #         python3 -m venv venv
    #         . venv/bin/activate
    #         pip install --upgrade pip
    #         pip install -r requirements.txt
    #   - save_cache:
    #       key: deps1-{{ .Branch }}-{{ checksum "requirements.txt" }}
    #       paths:
    #         - "venv"
#       - run:
#           command: |
#             . venv/bin/activate
#             python -m pytest -v tests/test_script.py
#       - store_artifacts:
#           path: test-reports/
#           destination: tr1
#       - store_test_results:
#           path: test-reports/
#       - setup_remote_docker:
#           version: 19.03.13
      # - run:
      #     name: Build and push Docker image
      #     command: |
      #       docker build -t $DOCKERHUB_USER/$IMAGE_NAME:$TAG .
      #       docker login -u $DOCKERHUB_USER -p $DOCKER_HUB_PASSWORD_USER docker.io
      #       docker push $DOCKERHUB_USER/$IMAGE_NAME:$TAG

# workflows:
#   build-test-deploy:
#     jobs:
#       - build-and-test
